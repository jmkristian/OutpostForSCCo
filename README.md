This software augments
[Outpost Packet Message Manager](https://www.outpostpm.org),
adding forms that are used for emergency communication by ARES and RACES
in Santa Clara County, California.
It uses the [add-on interface](http://www.outpostpm.org/docs/Outpost320-AddonUG.pdf)
to Outpost, and a web browser to display and edit forms.

For installation and usage directions, see the UserGuide.html file
in each [release](https://github.com/jmkristian/OutpostForSCCo/releases).

Building Installers
-------------------

Source code is stored in this repository.
To build it, you'll need:
* [Git](https://git-scm.com/downloads) configured with core.autocrlf true,
  so it will check out text files with CRLF but check them in with LF.
  Please configure user.name and user.email to identify you as the author.
* [nvm for Windows](https://github.com/coreybutler/nvm-windows)
* [NSIS](http://nsis.sourceforge.net) version 3 or later,
  with the [Simple Firewall Plugin](https://nsis.sourceforge.io/NSIS_Simple_Firewall_Plugin).
* [SignTool](https://docs.microsoft.com/en-us/windows/win32/seccrypto/signtool),
  which is included in the
  [Windows SDK](https://developer.microsoft.com/en-us/windows/downloads/sdk-archive/)
  feature Windows App Certification Kit.
* a code signing certificate and private key
* a bash shell.
  The bash shell included with Git for Windows is sufficient.

Using [nvm](https://github.com/coreybutler/nvm-windows),
install the 32-bit variants of
[Node.js](https://nodejs.org/en/download/)
[version 4.9.1](https://nodejs.org/download/release/v4.9.1/) (yes that old)
and version 10.18.1.
Run "nvm install" from a Windows cmd or PowerShell prompt (not bash).
That old version of Node.js builds code that runs on Windows XP; newer versions don't.

In your PATH environment variable, add the folder that contains SignTool.exe
(so it can be executed by the script sign.cmd).

1. Clone this repository. In your clone:
1. Create a file signingCert.pfx,
   which contains your code signing certificate and private key,
   in PKCS#12 format with no password.
1. Download [Chromium](https://www.chromium.org/getting-involved/download-chromium/)
   version 81.0.4044.92 to webToPDF/bin/Chromium-81.0.4044.92.
1. Use bash to run webToPDF/build.sh
1. Use bash to run ./build.sh,
   which will create several installer .exe files, one for each add-on.

Install Outpost before installing any add-on.
After installing an add-on, exit and restart Outpost.

The installer source code is setup.nsi.
The source for most of the installed code is bin/Outpost\_Forms.js.
The installer configures Outpost to execute launch.js.
For debugging, you might change the configuration to execute launch-v.cmd instead.

To develop a new add-on:
* create form-\*.html files in pack-it-forms.
* create Addon.nsi and Addon.launch files in pack-it-forms/resources/integration/scco,
  using Los\_Altos.nsi and Los\_Altos.launch as models.
* add a command into pack-it-forms/resources/integration/scco/build.sh,
  using the existing commands as models.

Other configuration files will be generated by bin/Outpost\_Forms.js#installConfigFiles.

If you need to store new forms in a private repository, organize them in parallel with pack-it-forms.
At a minimum, the private repository should contain form-\*.html files,
and a resources/integration/scco folder that contains build.sh, Addon.nsi and Addon.launch files.
Use the files from pack-it-forms as models.
Pass the name of your private repository to ./build.sh on the command line.

Developing Forms
================

Most changes to forms will be done in
[pack-it-forms](https://github.com/jmkristian/pack-it-forms)
(not this repository).
To get started, replace the pack-it-forms sub-folder with a clone of the pack-it-forms repository.
Run build.sh to create installers, and install the add-on you wish to develop.

To test your changes, you can build and run a new installer.
If you've only changed HTML files, you can update the installed files by executing

`    node buildHTML.js pack-it-forms <installed folder>/pack-it-forms`

For example:

`    node buildHTML.js pack-it-forms C:/PackItForms/Outpost/SCCo/pack-it-forms`

When you've finished form development, release pack-it-forms and then use the new released version here.
That is:
1. Commit changes to pack-it-forms and push them to GitHub.
1. Release pack-it-forms on GitHub and create a new release tag for it.
1. Move your clone of pack-it-forms out of OutpostForSCCo.
1. Update ./build.sh to refer to the new release tag of pack-it-forms.
1. Build new installers and test them.
1. Commit changes to OutpostForSCCo and push them to GitHub.
1. Release OutpostForSCCo on GitHub, with the new installers as assets.

The easiest way to start creating a new form is to copy an existing form.
Each form is a file named pack-it-forms/form-\*.html, containing mostly HTML.
Copy a form-\*.html file,
find the `<form>` element with `id="the-form"` and edit its contents.
The rest of the file is mostly boilerplate that you need not change.
Assuming you start with all the boilerplate in place, you should:
 
* Change the title
* Edit input elements
* Set up default and on-submit behavior on fields
* Adjust layout and styling
* Clean up Javascript

The next sections cover each of these in detail.

Change the Title
----------------

Change the contents of the `title` element to be the name of the form.
Browsers will display this title, and you may refer to it elsewhere in the form.

Edit Input Elements
-------------------

Fields in your form are HTML `input`, `select`, and `textarea` elements, as usual in HTML.
Each input element must have a `name` attribute formatted like this:

   * In most cases, the name should be a number
     followed by a period followed by a short description.
     For example, `name="10.subject"`.
     The number (but not the description) will identify the information in Outpost messages.
   * Otherwise, just use a short, descriptive name like `"Method"`.
     The whole field name will identify the information in Outpost messages.

You can give an `input` a standard style, validation pattern and placeholder
by adding one of these classes to its class attribute:

* date
* time
* phone-number
* cardinal-number
* real-number
* call-sign

You can override the standard style, pattern and/or placeholder with
HTML attributes, as usual.

The `select` element is used when the user should pick from a set of known values.
It's good practice to make the `value` attribute of each option
the same as the text within the `option` element.
That way, anyone viewing the message text will see a value they understand.

You can add descriptions to inputs in various ways.
These ways work well with the default CSS:

   * If the control is a single control, wrap it in a `label` element
     with the description preceding the `input` element.
   * If you're using something like a set of radio buttons that
     need to be grouped together, use the same scheme for each element
     but wrap them in a `fieldset` element with a `legend` element
     including the description of the entire set.
   * If the paper form has a field number, wrap the number in a `<span class="field-number">`.
     This shows the number as a small superscript, like an ICS-213 form.

Many forms have some standard fields,
for example to say who transmitted the form, to whom it was transmitted etc.
To define these fields, you can include fragments of HTML from other files.
If an HTML file contains a tag like `<%#include%>resources/html/file.html<%/include%>`,
that tag will be replaced with the contents of file.html.
You can customize an included file with a tag like:

        <%#run%>include("resources/html/scco-header.html", {title: "Status Report"})<%/run%>

That's a JavaScript function call.
The second parameter to the include function is a JavaScript object.
Within the included file, a tag like `<%title>` or `<%&title>`
will be replaced with the value of the title field
or, if there is no such field, an empty string.
A `<%title%>` tag will convert special characters like < and > to HTML codes;
a `<%&title%>` tag won't convert them.

If an input element represents a field that should have different
values in a receiver's copy of a form than the sender's, give the field
the class `no-msg-init`, which will prevent the sender's field value
(which is included in the message data) from being populated into the
field for display.  Use the template system (described in the next
section) to substitute a different value for the receiver or the
transmitter.
For examples, see `scco-header.html` and `scco-footer.html`.


Set up Default and On-submit Behavior on Fields
-----------------------------------------------

Some fields have a normal value which the operator rarely edits,
and some fields have a value that cannot be edited.
These default values can be specified in HTML, as usual.
Also, a `<select>` may have a `data-default-value` attribute,
whose value matches the value of the default `<option>`.
A collection of radio buttons may have a data-default-value
attribute on any one of the buttons, whose value matches
the value of the default button.
A checkbox may have a data-default-value, in which case it will
be checked by default if and only if the data-default-value is
not "false" or an empty string.

Any of these default values may be a template.
Regular text in templates is copied from the template to the resulting
string.  The difference comes when placeholder values that are
surrounded by double curly braces are encountered.  To give an
example, on January 1st, 2020, the template:

        The date is: {{date}}.

will result in the output text:

        The date is: 01/20/2020.

This is the simplest possible template value, with just the name of
the template to use.  Some template types require additional
information, in which case it can be supplied after the template name,
separated by a colon. For example,
if the form has a field named "foo" whose current value is "bar",

        That is {{field:foo}}.

will result in the output text:

        That is bar.

Finally, the output of template expansion can be further modified by
filters.  Filters are separated from the template type by a vertical
bar character "|".  Filters can also take an argument separated by a
colon.  Assuming again that the date is January 1st, 2020, an example
of a filter is:

        The month is: {{date|truncate:2}}

will result in the output text:

        The month is: 01

because "01" is the first two characters of the date string that would
be substituted without the filter.  Multiple filters can be chained
together one after another, each separated by a vertical bar.

The following template types are available:

| Name              | Argument   | Description                                     |
|-------------------|------------|-------------------------------------------------|
| date              | none       | Current date string in "mm/dd/yyyy" format      |
| time              | none       | Current local time string in hh:mm:ss format    |
| selected-fields   | css-sel    | Get list of field values returned by `css-sel`  |
| field             | field name | Value of a field in the form                    |
| msg-field         | field name | Value of a field in the received message        |
| envelope          | see below  | Information about the sender or receiver        |
| filename          | none       | Final name in URI path of the form              |
| title             | none       | Title of the HTML document                      |
| expand-while-null | templates  | Comma separated templates (\, escapes)          |
| value             | any        | Insert the argument                             |
| open-brace        | none       | Insert a single '{' character                   |
| close-brace       | none       | Insert a single '}' character                   |
| open-tmpl         | none       | Insert a template open string ('{{')            |
| close-tmpl        | none       | Insert a template close string ('}}')           |

The difference between `field` and `msg-field` is subtle but
important.  The `field` type retrieves the value of the form field
with the given name.  If the field exists in the form it will always
get the current contents of that form element in the DOM.  The
`msg-field` type retrieves the value of a form field that was sent in
a received message.  When creating a new form, all msg-field fields
will have a value that is the empty string.  This distinction is
important because some form fields have different values in the sender
and receiver version of the form.

The argument to the `envelope` template may start with either "sender_" or "receiver_",
to say whether it expands to information relating to the sender of the message
or the receiver of the message, respectively.
The rest of the argument may be any one of:

| Name                | Description                                           |
|---------------------|-------------------------------------------------------|
| message_number      | assigned message number                               |
| operator_call_sign  | Call sign of the operator (legal or tactical)         |
| operator_name       | Name of the operator (personal or tactical)           |
| date                | calendar date when the message was sent or received   |
| time                | time of day when the message was sent or received     |

For example, {{envelope:receiver_operator_name}} expands to the name
of the operator who received the message, and
{{envelope:sender_message_number}} expands to the message number that was
assigned at the sender's station.

The argument to the envelope template may also start with "viewer_",
which means it expands to information relating to the current operator's role.
So, it's equivalent to "sender_" when viewing a transmitted message, or
"receiver_" when viewing a received message.
And finally, if the argument to the envelope template is simply "viewer",
it expands to either "sender" or "receiver".

The following filters are available:

| Name       | Argument  | Description                                        |
|------------|-----------|----------------------------------------------------|
| truncate   | length    | Truncate string to max of `length` characters      |
| split      | fld delim | Split into list by `fld delim` string              |
| join       | separator | Join list with `separator` between elements        |
| remove     | value     | Remove elements matching `value` from list         |
| sort       | type      | Sort list, if `type` is 'num', numeric, else text  |
| re_search  | regexp    | Match regexp match, returning text or capture list |
| nth        | index     | Return the nth list item or character              |
| trim       | none      | Remove whitespace at start and end of string       |
| msgno2name | msgno     | Expand message number to station                   |
| expandtmpl | none      | Apply another layer of template expansion          |
| view-by    | role      | Expands to an empty string, unless arg == the operator's role (either sender or receiver) |

When the form is loaded, template expansion will be performed on
the `value` property of input elements with `type="text"`,
the `innerHTML` property of \<span\> and \<div\> elements with a `templated` class,
and any data-default-value.
However, templates in elements with the class `no-load-init` will not be expanded.
The same templates will be expanded when the form is reset.

If a form field has the class `init-on-submit`, its value is expanded as
a template immediately before submitting it to Outpost.
Such a field usually also has the class no-load-init, so the template will
be shown to the operator, to suggest that something will be filled in later.

You can use use
[form validation](https://developer.mozilla.org/en-US/docs/Learn_web_development/Extensions/Forms/Form_validation)
for input fields.
The default CSS provides a visual indication of which fields are invalid,
and the top bar changes color depending on whether or not the form is fully valid.
Here are some tips to get you started:

   * If you have a field that must have some input in it, add the
     attribute `required`.
   * If the contents of the field has to be in a certain format, add a
     `pattern` attribute: the value should be a regular expression
     that will match values of the desired format.

Adjust Layout and Styling
-------------------------

Forms should be styled to look like paper forms,
and have a fairly responsive layout that will work with a variety of screen sizes.

Delete any styles that you copied from another form, but aren't used in your form.
If your form requires specific styling, place it in a `style` element within the `head`.
If several forms need to share styling, place it in a .css file in pack-it-forms/resources/css.

Clean up Javascript
-------------------
Delete any Javascript that you copied from another form, but isn't used in your form.
If several forms need to share the same Javascript, place it in a .js file in pack-it-forms/resources/js.
But don't edit pack-it-forms/resources/js/pack-it-forms.js, as a rule. That file is used by every form.

Customize
---------

To link from the form to a PDF version (suitable for printing),
add the PDF file into the pack-it-forms/resources/pdf folder and
add a tag like this inside the HTML \<head\>:

`<meta name="pack-it-forms-pdf-URL" content="pdf/File_Name.pdf"/>`

By default, the subject of the message submitted to Outpost is
Santa Clara County's standard for an ICS-213 message; that is
(message number)\_(handling)\_(form name)\_(subject).
For example, "XND-123P_R_ICS 213_Advice to Cities".
To customize the part following (handling),
you can add a tag like this inside your form's HTML \<head\>:

`<meta name="pack-it-forms-subject-suffix" content="_Advice_{{field:27.city}}"/>`

This content attribute may be a template.

Mustache Tags
-------------
You can do more with tags delimited by `<% %>`.
These tags are rendered by [Mustache.js](https://github.com/janl/mustache.js),
at build time, before `{{ }}` tags are expanded.
Several tags are predefined:
- `<%nextTabIndex%>` the next integer in a sequence starting with 1.
- `<%sameTabIndex%>` the same integer as the last nextTabIndex.
  This is useful for a group of radio buttons, which usually all have the same tabindex.
- `<%&nextFieldNumber%>` either an empty string, or `<span class="field-number">N</span>`
  where N is the next integer in a sequence.
- `<%#include%> fileName <%/include%>` shorthand for `<%#run%>include("fileName")<%/run%>`.
- `<%#run%> script <%/run%>` the
  [completion value](https://www.mattzeunert.com/2017/01/10/whats-a-statement-completion-value-in-javascript.html)
  of the given JavaScript script.
  The script can use several global objects, including:
  - `nextTabIndex` the integer that will be rendered by <%nextTabIndex%>. The default value is 1.
  - `nextFieldNumber` the integer that will be rendered by <%&nextFieldNumber%>.
    The default value is -1, meaning <%&nextFieldNumber%> will render an empty string.
    You can start a sequence of consecutive field numbers by setting this variable to a non-negative value.
  - `include(fileName, context)` a function that renders a template read from the named file,
    with keys defined by the optional given context.
    The fileName is relative to the folder pack-it-forms (which contains the form-\*.html files).

Boilerplate
-----------

All form-\*.html files should contain the following boilerplate:

  <!DOCTYPE html>
    <html>
      <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">

Specify the UTF-8 encoding of HTML and field values.

        <link rel="stylesheet" type="text/css" href="resources/css/loading.css"/>

CSS that works with loading.html, to hide the form during initialization.

        <link rel="stylesheet" type="text/css" href="resources/css/pack-it-forms.css"/>

CSS for form interaction elements that's useful in all forms.

        <script type="text/javascript" src="resources/js/pack-it-forms.js"></script>
        <script type="text/javascript" src="resources/integration/integration.js"></script>
 
Javascript files that implement the form's behavior.

        <title>ICS213: Message Form</title>

The name of this form.

        <%#include%>resources/html/loading.html<%/include%>

A loading progress bar, with diagnostic information if something goes wrong.

        <form id="the-form" name="the-form">
           ...
        </form>

The actual form itself replaces the ellipses here.
The <form> element must have id="the-form".

        <%#include%>resources/html/submit-buttons.html<%/include%>

Buttons to reset the form, submit the completed form etc.
This should come after the form.

      </body>
    </html>

Standard HTML5 body and document close.
