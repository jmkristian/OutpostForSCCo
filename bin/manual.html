<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="resources/css/pack-it-forms.css"/>
    <style>
      form {
          max-width: 8in;
          min-width: 5in;
      }
      form input[type="submit"] {
          background-color: #ffffff;
          font-weight: bold;
      }
      form input[type="submit"]:enabled  {
          background-color: #a8e8a8;
      }
      table.block {
          background-color: #f8f8f8;
      }
      table.block-caption {
          background-color: #bbeeff;
          border-top: 1px solid #aaaaaa;
          margin-top: 2em;
      }
      table.block-caption td {
          padding: 4pt 4pt;
      }
      td.label-sameline{
          font-weight: bold;
          width: 1px;
      }
    </style>
    <title>SCCo PackItForms</title>
    <script type="text/javascript">
      setInterval(function() {
          var img = new Image();
          // To discourage caching, use a new query string for each ping.
          img.src = "/ping-{{pageId}}?i=" + Math.random();
          img = undefined;
      }, 30000); // call ping every 30 seconds
      function selectAll(element) {
          setTimeout(function() {
              element.select();
              element.scrollTop = 0;
          }, 5);
      }
      function fireEvent(target, eventName) {
          var event = document.createEvent('Event');
          event.initEvent(eventName, true, true);
          target.dispatchEvent(event);
          onInput();
      }
      function changeValue(inputID, newValue) {
          var input = document.getElementById(inputID);
          if (input && input.value != newValue) {
              input.value = newValue;
              fireEvent(input, 'change');
          }
      }
      function setEnabled(button, enabled) {
          button.disabled = !enabled;
      }
      function onInput() {
          // Form validity doesn't get updated immediately.
          // So wait a bit before calling checkValidity.
          setTimeout(function checkFormsValid() {
              var valid = document.getElementById("create-form").checkValidity();
              var value = document.getElementById("create-type").value;
              setEnabled(document.getElementById("create-button"), valid && value);
              valid = document.getElementById("view-form").checkValidity();
              value = document.getElementById("message").value;
              setEnabled(document.getElementById("view-button"), valid && value && value.trim());
          }, 10);
      }
      function saveMessage(message) {
          var copy = document.getElementById("message-copy");
          if (copy && copy.value != message) {
              copy.value = message;
              var manualPut = document.getElementById("manual-put");
              manualPut.submit();
          }
          var subject = "message";
          var found = /[\r\n]Subject:([^\r\n]*)/.exec("\n" + message);
          if (found) {
              subject = found[1].trim();
          }
          document.getElementById("message-link").href =
              "/manual-get-{{pageId}}/"
              + encodeURIComponent(subject) + ".txt"
              + "?field=message";
      }
      function onMessageInput() {
          function twoDigits(number) {
              var result = number + "";
              while (result.length < 2) {
                  result = "0" + result;
              }
              return result;
          }
          var message = document.getElementById("message").value;
          var newDate = "";
          var newTime = "";
          if (message) {
              var now = new Date();
              newDate = twoDigits(now.getMonth() + 1)
                  + "/" + twoDigits(now.getDate())
                  + "/" + now.getFullYear();
              newTime = twoDigits(now.getHours())
                  + ":" + twoDigits(now.getMinutes());
          }
          saveMessage(message);
          changeValue("message-number", "");
          changeValue("message-date", newDate);
          changeValue("message-time", newTime);
          onInput();
      }
      function uploadMessage(file) {
          var reader = new FileReader();
          reader.onload = function(e) {
              var message = document.getElementById("message");
              message.value = e.target.result;
              document.getElementById("message-file-name").innerText = file.name;
              onMessageInput();
          };
          reader.readAsText(file);
      }
      function onMessageFile(input) {
          document.getElementById("message-file-name").innerText = "";
          if (input.value) {
              uploadMessage(input.files[0]);
          }
      }
      function onMessageDrop(event) {
          uploadMessage(event.dataTransfer.files[0]);
          event.preventDefault();
          event.stopPropagation();
          return false;
      }
      function onMessageClear() {
          document.getElementById("message-file-name").innerText = "";
          onInput();
      }
      function onLoad() {
          var message = document.getElementById("message");
          message.addEventListener('change', onMessageInput);
          message.addEventListener('input', onMessageInput);
          Array.prototype.forEach.call(document.querySelectorAll(
              'form input[type="text"]'), function(input) {
                  input.addEventListener('change', onInput);
                  input.addEventListener('input', onInput);
              });
          // Wait for field values to be initialized (e.g. when navigating back).
          setTimeout(function() {
              onInput();
              saveMessage(message.value);
              var opName = document.getElementById("op-name");
              if (!opName.value) {
                  opName.focus();
              }
          }, 10);
      }
      window.onload = onLoad;
    </script>
  </head>
  <body style="padding-top:1em;background-color:#d0d0d0;">
    <span style="font-size:125%;font-weight:bold;">Santa Clara County ARES/RACES PackItForms</span>
    <span style="float:right;">PIF: 2.1</span>
    <form id="create-form" action="/manual-create" method="POST" target="_blank">
      <input type="text" style="display:none;" name="addon_name" value="{{addon_name}}"/>
      <input type="text" style="display:none;" name="addon_version" value="{{addon_version}}"/>
      <table class="same-line-label-layout" style="margin-top:1em;">
        <tr>
          <td class="label-sameline">
            Operator name:
            <input type="text" id="op-name" name="operator_name" required
                   oninput="changeValue('op-name-copy', this.value)"
                   placeholder="for example Herman Munster"
                   title="for example Herman Munster"
                   style="width:20em;margin-right:1em;"/>
            FCC Call sign:
            <input type="text" id="op-call" name="operator_call_sign" required
                   oninput="changeValue('op-call-copy', this.value)"
                   class="call-sign"/>
          </td>
        </tr>
      </table>
      <table class="block-caption">
        <tr>
          <td>Create a form to send</td>
        </tr>
      </table>
      <table class="block">
        <tr>
          <td class="label-sameline">
            Form type:
            <select id="create-type" name="ADDON_MSG_TYPE" required onchange="onInput()">
              <option value="" selected disabled></option>{{form_options}}
            </select>
          </td>
        </tr><tr>
          <td>
            <input type="submit" id="create-button" value="Create Form" disabled/>
          </td>
        </tr>
      </table>
    </form>
    <form id="view-form" action="/manual-view" method="POST" target="_blank">
      <input type="text" style="display:none;" name="addon_name" value="{{addon_name}}"/>
      <input type="text" style="display:none;" name="addon_version" value="{{addon_version}}"/>
      <input type="text" style="display:none;" required id="op-name-copy" name="operator_name"/>
      <input type="text" style="display:none;" required id="op-call-copy" name="operator_call_sign"/>
      <table class="block-caption">
        <tr>
          <td>View a received message</td>
        </tr>
      </table>
      <table class="block">
        <tr>
          <td colspan="4">
            Enter the received message, including the Subject and other headers.
            You can paste, drag and drop or upload a file.
          </td>
        </tr><tr>
          <td colspan="4">
            <table class="same-line-label-layout">
              <tr>
                <th>
                  Message:
                  <br/><br/>
                  <input type="button" value="Upload"
                         onclick="document.getElementById('message-file').click()"/>
                  <input type="file" id="message-file" style="display:none;"
                         onchange="onMessageFile(this)"/>
                  <span id="message-file-name" style="display:none;"></span>
                  <br/><br/>
                  <a id="message-link" target="_blank" href=""
                     style="font-weight:normal;">Download</a>
                </th><td>
                  <textarea name="message" id="message" rows="12" style="font-weight:normal;" required
                            placeholder="Date: ...&#10;Subject: ...&#10;&#10;!{{addon_name}}!&#10;#T: ...&#10;MsgNo: [XYZ-123P]&#10;...&#10;!/ADDON!"
                            onfocus="selectAll(this)" ondrop="return onMessageDrop(event)"
                            ></textarea>
                </td>
              </tr>
            </table>
          </td>
        </tr><tr>
          <td class="label-sameline">
            Destination Message Number:
            <input type="text" id="message-number" name="MSG_LOCAL_ID" required
                   class="message-number">
          </td><td class="label-sameline">
            Date:
            <input type="text" id="message-date" name="OpDate" required class="date"
                   pattern="(0[1-9]|1[012])/(0[1-9]|1[0-9]|2[0-9]|3[01])/[1-2][0-9][0-9][0-9]"
                   placeholder="mm/dd/yyyy"/>
          </td><td class="label-sameline">
            Time:
            <input type="text" id="message-time" name="OpTime" required class="time"
                   pattern="([01][0-9]|2[0-3]):?[0-5][0-9]|2400|24:00"
                   placeholder="hh:mm"/>
          </td><td>
          </td>
        </tr><tr>
          <td colspan="4">
            <input type="submit" id="view-button" value="View Form" disabled/>
            <input type="reset" value="Reset Fields" style="margin-left:2em;"
                   onclick="onMessageClear(event)"/>
          </td>
        </tr>
      </table>
    </form>
    <form style="display:none" id="manual-put"
          method="POST" action="/manual-put-{{pageId}}" target="hidden-iframe">
      <textarea name="message" id="message-copy"></textarea>
      <iframe name="hidden-iframe"></iframe>
    </form>
  </body>
</html>
