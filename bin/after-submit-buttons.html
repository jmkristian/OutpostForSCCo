<script type="text/javascript">
    // Monkey patch load_callprefix:
    for (var i = startup_functions.length - 1; i >= 0; i--) {
        if (startup_functions[i] === load_callprefix) {
            startup_functions[i] = function(next) {
                var message = {{message}};
                var environment = {{environment}};
                set_form_data_div(message || '# A new message will go here.');
                var status = environment.message_status;
                viewer = (status == 'read' || status == 'unread') ? 'receiver' : 'sender';
                envelope.readOnly = (environment.mode == 'readonly');
                envelope[viewer].msgno = environment.msgno || '';
                envelope[viewer].ocall = environment.ocall || '';
                envelope[viewer].oname = environment.oname || '';
                envelope[viewer].ordate = environment.ordate || '';
                envelope[viewer].ortime = environment.ortime || '';
                if (environment.submitURL) {
                    document.querySelector('#form-data-form').action = environment.submitURL;
                }
                if (environment.pingURL && !envelope.readOnly) {
                    // Ping the server periodically, to keep it alive while the form is open.
                    // But not for a read-only message.
                    var ping_sequence = 0;
                    setInterval(function() {
                        var img = new Image();
                        // To discourage caching, use a new query string for each ping.
                        img.src = environment.pingURL + '?i=' + (ping_sequence++);
                        img = undefined;
                    }, 30000); // call ping every 30 seconds
                }
                var recSentValue = (viewer == "sender") ? "Sent" : "Received";
                // Show Rec-Sent based on whether we received this message:
                array_for_each(document.getElementsByName('Rec-Sent'), function(recSent) {
                    recSent.disabled = true; // Don't include it in transmitted messages.
                    recSent.classList.add('no-msg-init'); // Ignore it in received messages.
                    // That is, init_form_from_fields won't affect this element any more.
                    init_from_msg_funcs[recSent.type](recSent, recSentValue);
                });
                // Change the message header from PACF format to ADDON format:
                newMessage.header = function() {
                    return '!' + environment.addon_name + '!'
                        + '\r\n# ' + document.title
                        + '\r\n# JS-ver. PR-3.9-2.6, 08/11/13,'
                        + '\r\n# FORMFILENAME: ' + environment.filename
                        + '\r\n# FORMVERSION: ' + formVersion()
                        + '\r\n# SUBJECT: ' + newMessage.subject()
                        + '\r\n';
                };
                newMessage.footer = '!/ADDON!\r\n';
                if (status == 'manual') {
                    var submitButton = document.getElementById('opdirect-submit');
                    if (submitButton) {
                        submitButton.value = 'Create Message';
                    }
                }
                if ((status == 'new' || status == 'draft') && envelope.readOnly) {
                    // This message was just submitted to Outpost. Let the operator know:
                    var div = document.createElement('div');
                    div.style="position:absolute;height:20pt;top:50%;margin-top:-10pt;margin-left:5pt;font-weight:bold;";
                    div.innerHTML =
                        '<img src="icon-check.png" alt="OK" style="width:20pt;height:20pt;vertical-align:middle;">' +
                        '&nbsp;&nbsp;The message has been submitted to Outpost. You can close this page.';
                    document.getElementById('button-header').appendChild(div);
                }
                next();
            };
            break;
        }
    }
</script>
