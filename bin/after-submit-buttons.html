<script type="text/javascript">
    var formDefaultValues; // Initial values for form inputs.
    // Monkey patch load_callprefix:
    for (var i = startup_functions.length - 1; i >= 0; i--) {
        if (startup_functions[i] === load_callprefix) {
            startup_functions[i] = function(next) {
                try {
                    outpost_envelope = {{envelopeDefaults}};
                    var message = {{message}};
                    if (message) {
                        set_form_data_div(message);
                    }
                    var queryDefaults = {{queryDefaults}};
                    for (var q in queryDefaults) {
                        if (!(q in query_object)) {
                            query_object[q] = queryDefaults[q];
                        }
                    }
                    if (query_object.submitURL) {
                        document.querySelector('#form-data-form').action = query_object.submitURL;
                    }
                    if (query_object.pingURL && query_object.mode != 'readonly') {
                        // Ping the server periodically, to keep it alive while the form is open.
                        // But not for a read-only message.
                        setInterval(function() {
                            var img = new Image();
                            img.src = query_object.pingURL;
                            img = undefined;
                        }, 30000); // call ping every 30 seconds
                    }
                    if (!formDefaultValues) {
                        formDefaultValues = [];
                    }
                    var status = query_object.message_status;
                    // Show Rec-Sent based on whether we received this message:
                    formDefaultValues.push({'Rec-Sent': (status == 'unread' || status == 'read') ? 'Received' : 'Sent'});
                    for (var f = formDefaultValues.length - 1; f >= 0; f--) {
                        init_form_from_fields(formDefaultValues[f], 'name');
                    }
                    var recSents = document.getElementsByName('Rec-Sent');
                    for (var r = 0; r < recSents.length; r++) {
                        var recSent = recSents[r];
                        recSent.disabled = true; // Don't include it in transmitted messages.
                        recSent.classList.add('no-msg-init'); // Ignore it in received messages.
                        // That is, init_form_from_fields won't affect this element any more.
                    }
                    // Change the message header from PACF format to ADDON format:
                    var messageHeader = document.querySelector("#message-header");
                    var header = messageHeader.textContent;
                    // The subject comes after !PACF! in the first line:
                    var found = /^\s*![^!\r\n]*!\s*([^\r\n]*)/.exec(header);
                    // Remove that first line:
                    header = header.replace(/^\s*![^!\r\n]*![^\r\n]*[\r\n]*/, '');
                    if (found) {
                        // Add the subject in a comment:
                        header = header.replace(/\s*$/, '\r\n# SUBJECT: ' + found[1]);
                    }
                    messageHeader.textContent = header;
                    if (status == 'new' && query_object.mode == 'readonly') {
                        // This message was just submitted to Outpost. Let the operator know:
                        var div = document.createElement('div');
                        div.style="position:absolute;height:20pt;top:50%;margin-top:-10pt;margin-left:5pt;font-weight:bold;";
                        div.innerHTML =
                            '<img src="icon-check.png" alt="OK" style="width:20pt;height:20pt;vertical-align:middle;">' +
                            '&nbsp;&nbsp;The message has been submitted to Outpost. You can close this page.';
                        document.querySelector("#button-header").appendChild(div);
                    }
                } catch(err) {
                    logError(JSON.stringify(err));
                }
                next();
            };
            break;
        }
    }
</script>
